<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资大师分析 - VIMaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .master-card { transition: all 0.3s ease; cursor: pointer; }
        .master-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .master-card.selected { border: 3px solid #198754; }
        .master-avatar { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; margin: 0 auto 1rem; }
        .signal-badge { font-size: 1.2rem; padding: 0.5rem 1rem; }
        .reasoning-text { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-graph-up-arrow"></i> VIMaster</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house"></i> 首页</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown"><i class="bi bi-search"></i> 分析</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/analyze"><i class="bi bi-cpu"></i> 基础分析</a></li>
                            <li><a class="dropdown-item active" href="/masters"><i class="bi bi-mortarboard"></i> 大师分析</a></li>
                            <li><a class="dropdown-item" href="/experts"><i class="bi bi-person-workspace"></i> 专家分析</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/portfolio"><i class="bi bi-briefcase"></i> 投资组合</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="bi bi-mortarboard text-success"></i> 投资大师分析</h2>
                <p class="text-muted">使用 7 位世界级投资大师的投资理念分析股票，获取多维度投资建议</p>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：输入和大师选择 -->
            <div class="col-md-4">
                <!-- 股票输入 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-search"></i> 股票代码</h5>
                    </div>
                    <div class="card-body">
                        <input type="text" class="form-control form-control-lg" id="stockCode" placeholder="如：600519">
                        <div class="form-text">输入沪深 A 股代码</div>
                    </div>
                </div>

                <!-- 大师选择 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> 选择大师</h5>
                        <button class="btn btn-sm btn-light" id="selectAllBtn">全选</button>
                    </div>
                    <div class="card-body" id="mastersList">
                        <div class="text-center py-3"><div class="spinner-border"></div></div>
                    </div>
                </div>

                <!-- 分析按钮 -->
                <button class="btn btn-success btn-lg w-100" id="analyzeBtn">
                    <i class="bi bi-lightning"></i> 开始大师分析
                </button>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>提示：</strong>大师分析需要配置 LLM API 密钥才能正常运行。
                </div>
            </div>

            <!-- 右侧：结果展示 -->
            <div class="col-md-8">
                <div id="resultsArea">
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-mortarboard display-1 text-muted"></i>
                            <h4 class="mt-3 text-muted">选择大师并输入股票代码</h4>
                            <p class="text-muted">每位大师将根据自己的投资理念给出独立分析</p>
                            <div class="mt-4">
                                <span class="badge bg-primary me-2">巴菲特</span>
                                <span class="badge bg-success me-2">格雷厄姆</span>
                                <span class="badge bg-info me-2">芒格</span>
                                <span class="badge bg-warning me-2">费雪</span>
                                <span class="badge bg-danger me-2">德鲁肯米勒</span>
                                <span class="badge bg-secondary me-2">凯西·伍德</span>
                                <span class="badge bg-dark">阿克曼</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">VIMaster v2.0 - 让价值投资更智能</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedMasters = [];
        const masterColors = ['primary', 'success', 'info', 'warning', 'danger', 'secondary', 'dark'];

        document.addEventListener('DOMContentLoaded', loadMasters);

        function loadMasters() {
            fetch('/api/agents/masters')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('mastersList');
                        let html = '';
                        data.data.forEach((master, i) => {
                            const color = masterColors[i % masterColors.length];
                            const initials = master.name.replace('Agent', '').substring(0, 2);
                            html += `
                                <div class="master-card card mb-2 p-2" data-name="${master.name}" onclick="toggleMaster(this, '${master.name}')">
                                    <div class="d-flex align-items-center">
                                        <div class="master-avatar me-3" style="width:40px;height:40px;font-size:1rem;background:var(--bs-${color});">
                                            ${initials}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">${master.name.replace('Agent', '')}</h6>
                                            <small class="text-muted">${master.description.substring(0, 25)}...</small>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-success ms-auto" style="display:none;"></i>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    }
                });
        }

        function toggleMaster(el, name) {
            if (selectedMasters.includes(name)) {
                selectedMasters = selectedMasters.filter(m => m !== name);
                el.classList.remove('selected');
                el.querySelector('.bi-check-circle-fill').style.display = 'none';
            } else {
                selectedMasters.push(name);
                el.classList.add('selected');
                el.querySelector('.bi-check-circle-fill').style.display = 'block';
            }
        }

        document.getElementById('selectAllBtn').addEventListener('click', function() {
            const cards = document.querySelectorAll('.master-card');
            const allSelected = selectedMasters.length === cards.length;

            cards.forEach(card => {
                const name = card.dataset.name;
                if (allSelected) {
                    selectedMasters = [];
                    card.classList.remove('selected');
                    card.querySelector('.bi-check-circle-fill').style.display = 'none';
                } else {
                    if (!selectedMasters.includes(name)) {
                        selectedMasters.push(name);
                    }
                    card.classList.add('selected');
                    card.querySelector('.bi-check-circle-fill').style.display = 'block';
                }
            });

            this.textContent = allSelected ? '全选' : '取消全选';
        });

        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                alert('请输入股票代码');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 分析中...';

            document.getElementById('resultsArea').innerHTML = `
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-success" style="width:3rem;height:3rem;"></div>
                        <h4 class="mt-3">正在进行大师分析...</h4>
                        <p class="text-muted">AI 大师们正在分析 ${stockCode}</p>
                    </div>
                </div>
            `;

            fetch('/api/analyze/masters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    stock_code: stockCode,
                    masters: selectedMasters.length > 0 ? selectedMasters : null
                })
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-lightning"></i> 开始大师分析';

                if (data.success) {
                    renderResults(data.data);
                } else {
                    document.getElementById('resultsArea').innerHTML = `
                        <div class="alert alert-danger">${data.error}</div>
                    `;
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-lightning"></i> 开始大师分析';
                document.getElementById('resultsArea').innerHTML = `
                    <div class="alert alert-danger">分析失败: ${err}</div>
                `;
            });
        });

        function renderResults(data) {
            const signalColors = {bullish: 'success', bearish: 'danger', neutral: 'warning'};
            const signalIcons = {bullish: 'arrow-up-circle', bearish: 'arrow-down-circle', neutral: 'pause-circle'};
            const signalText = {bullish: '看涨', bearish: '看跌', neutral: '中性'};

            let html = `
                <!-- 共识卡片 -->
                <div class="card shadow-sm mb-4 border-${signalColors[data.consensus.consensus] || 'secondary'}">
                    <div class="card-header bg-${signalColors[data.consensus.consensus] || 'secondary'} text-white">
                        <h4 class="mb-0"><i class="bi bi-people"></i> 大师共识 - ${data.stock_code}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h1 class="text-${signalColors[data.consensus.consensus]}">${signalText[data.consensus.consensus] || '未知'}</h1>
                                <p class="text-muted">共识信号</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-success">${data.consensus.bullish_count}</h2>
                                <p class="text-muted">看涨</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-warning">${data.consensus.neutral_count}</h2>
                                <p class="text-muted">中性</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-danger">${data.consensus.bearish_count}</h2>
                                <p class="text-muted">看跌</p>
                            </div>
                        </div>
                        <div class="progress mt-3" style="height: 30px;">
                            <div class="progress-bar bg-success" style="width: ${data.consensus.bullish_count / (data.masters.length || 1) * 100}%">
                                看涨 ${data.consensus.bullish_count}
                            </div>
                            <div class="progress-bar bg-warning" style="width: ${data.consensus.neutral_count / (data.masters.length || 1) * 100}%">
                                中性 ${data.consensus.neutral_count}
                            </div>
                            <div class="progress-bar bg-danger" style="width: ${data.consensus.bearish_count / (data.masters.length || 1) * 100}%">
                                看跌 ${data.consensus.bearish_count}
                            </div>
                        </div>
                        <p class="text-center mt-2 mb-0">
                            平均信心度: <strong>${(data.consensus.average_confidence || 0).toFixed(1)}%</strong>
                        </p>
                    </div>
                </div>

                <!-- 各大师分析 -->
                <h5 class="mb-3"><i class="bi bi-person-lines-fill"></i> 各大师分析详情</h5>
            `;

            if (data.masters && data.masters.length > 0) {
                data.masters.forEach((master, i) => {
                    const color = signalColors[master.signal] || 'secondary';
                    html += `
                        <div class="card shadow-sm mb-3 border-${color}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <span class="badge bg-${masterColors[i % masterColors.length]} me-2">${master.name.replace('Agent', '').substring(0, 2)}</span>
                                    ${master.name.replace('Agent', '')}
                                </h5>
                                <span class="badge signal-badge bg-${color}">
                                    <i class="bi bi-${signalIcons[master.signal]}"></i> ${signalText[master.signal]}
                                    (${master.confidence.toFixed(1)}%)
                                </span>
                            </div>
                            <div class="card-body">
                                <h6>分析理由：</h6>
                                <div class="reasoning-text bg-light p-3 rounded">
                                    ${master.reasoning || '暂无详细理由'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-warning">未获取到大师分析结果，请确保已配置 LLM API 密钥</div>`;
            }

            document.getElementById('resultsArea').innerHTML = html;
        }
    </script>
</body>
</html>
