<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - VIMaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .api-key-input { font-family: monospace; }
        .provider-card { cursor: pointer; transition: all 0.2s; }
        .provider-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .provider-card.selected { border: 2px solid #0d6efd; background: #f8f9ff; }
        .key-status { font-size: 0.8rem; }
        .save-indicator { display: none; }
        .save-indicator.show { display: inline; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-graph-up-arrow"></i> VIMaster</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house"></i> 首页</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-search"></i> 分析</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/analyze">基础分析</a></li>
                            <li><a class="dropdown-item" href="/masters">大师分析</a></li>
                            <li><a class="dropdown-item" href="/experts">专家分析</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/portfolio">投资组合</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="/settings"><i class="bi bi-gear"></i> 设置</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container mt-4">
        <div class="row">
            <!-- 左侧菜单 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="#llm" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                        <i class="bi bi-robot"></i> LLM 模型配置
                    </a>
                    <a href="#general" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-sliders"></i> 通用设置
                    </a>
                    <a href="#agent" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-cpu"></i> Agent 配置
                    </a>
                    <a href="#notification" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-bell"></i> 通知设置
                    </a>
                    <a href="#about" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-info-circle"></i> 关于
                    </a>
                </div>
            </div>

            <!-- 右侧内容 -->
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- LLM 模型配置 -->
                    <div class="tab-pane fade show active" id="llm">
                        <div class="card shadow mb-4">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-robot"></i> LLM 模型配置</h5>
                                <span class="save-indicator badge bg-success" id="llmSaveIndicator">
                                    <i class="bi bi-check"></i> 已保存
                                </span>
                            </div>
                            <div class="card-body">
                                <!-- 默认模型选择 -->
                                <div class="mb-4">
                                    <h6><i class="bi bi-star"></i> 默认模型</h6>
                                    <p class="text-muted small">选择用于大师和专家分析的默认 LLM 模型</p>
                                    <select class="form-select" id="defaultProvider">
                                        <option value="">加载中...</option>
                                    </select>
                                </div>

                                <!-- API 密钥配置 -->
                                <div class="mb-4">
                                    <h6><i class="bi bi-key"></i> API 密钥配置</h6>
                                    <p class="text-muted small">配置各 LLM 提供商的 API 密钥（密钥将安全存储在本地）</p>

                                    <div class="accordion" id="apiKeysAccordion">
                                        <!-- OpenAI -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#keyOpenai">
                                                    <img src="https://openai.com/favicon.ico" width="20" class="me-2" onerror="this.style.display='none'">
                                                    OpenAI (GPT-4, GPT-3.5)
                                                    <span class="key-status ms-2" id="statusOpenai"></span>
                                                </button>
                                            </h2>
                                            <div id="keyOpenai" class="accordion-collapse collapse show" data-bs-parent="#apiKeysAccordion">
                                                <div class="accordion-body">
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                                        <input type="password" class="form-control api-key-input" id="apiKeyOpenai"
                                                               placeholder="sk-..." data-provider="openai">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKeyOpenai')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text">从 <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI 控制台</a> 获取</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Anthropic -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keyAnthropic">
                                                    <i class="bi bi-chat-dots me-2"></i>
                                                    Anthropic (Claude)
                                                    <span class="key-status ms-2" id="statusAnthropic"></span>
                                                </button>
                                            </h2>
                                            <div id="keyAnthropic" class="accordion-collapse collapse" data-bs-parent="#apiKeysAccordion">
                                                <div class="accordion-body">
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                                        <input type="password" class="form-control api-key-input" id="apiKeyAnthropic"
                                                               placeholder="sk-ant-..." data-provider="anthropic">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKeyAnthropic')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text">从 <a href="https://console.anthropic.com/" target="_blank">Anthropic 控制台</a> 获取</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- DeepSeek -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keyDeepseek">
                                                    <i class="bi bi-lightning me-2"></i>
                                                    DeepSeek
                                                    <span class="key-status ms-2" id="statusDeepseek"></span>
                                                </button>
                                            </h2>
                                            <div id="keyDeepseek" class="accordion-collapse collapse" data-bs-parent="#apiKeysAccordion">
                                                <div class="accordion-body">
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                                        <input type="password" class="form-control api-key-input" id="apiKeyDeepseek"
                                                               placeholder="sk-..." data-provider="deepseek">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKeyDeepseek')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text">从 <a href="https://platform.deepseek.com/" target="_blank">DeepSeek 控制台</a> 获取</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 通义千问 -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keyQwen">
                                                    <i class="bi bi-cloud me-2"></i>
                                                    阿里通义千问 (Qwen)
                                                    <span class="key-status ms-2" id="statusQwen"></span>
                                                </button>
                                            </h2>
                                            <div id="keyQwen" class="accordion-collapse collapse" data-bs-parent="#apiKeysAccordion">
                                                <div class="accordion-body">
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                                        <input type="password" class="form-control api-key-input" id="apiKeyQwen"
                                                               placeholder="sk-..." data-provider="qwen">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKeyQwen')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text">从 <a href="https://dashscope.console.aliyun.com/" target="_blank">阿里云灵积控制台</a> 获取</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 智谱 GLM -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keyZhipu">
                                                    <i class="bi bi-cpu me-2"></i>
                                                    智谱 GLM
                                                    <span class="key-status ms-2" id="statusZhipu"></span>
                                                </button>
                                            </h2>
                                            <div id="keyZhipu" class="accordion-collapse collapse" data-bs-parent="#apiKeysAccordion">
                                                <div class="accordion-body">
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                                        <input type="password" class="form-control api-key-input" id="apiKeyZhipu"
                                                               placeholder="..." data-provider="zhipu">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKeyZhipu')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text">从 <a href="https://open.bigmodel.cn/" target="_blank">智谱开放平台</a> 获取</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 高级设置 -->
                                <div class="mb-4">
                                    <h6><i class="bi bi-gear"></i> 高级设置</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="enableCache" checked>
                                                <label class="form-check-label" for="enableCache">启用响应缓存</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="logRequests" checked>
                                                <label class="form-check-label" for="logRequests">记录请求日志</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label class="form-label">缓存过期时间（秒）</label>
                                            <input type="number" class="form-control" id="cacheTtl" value="3600" min="60">
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent 专属模型配置 -->
                                <div class="mb-4">
                                    <h6><i class="bi bi-person-gear"></i> Agent 专属模型配置 <small class="text-muted">（可选）</small></h6>
                                    <p class="text-muted small">为特定 Agent 指定使用的模型，留空则使用默认模型</p>
                                    <div id="agentConfigsContainer">
                                        <!-- 动态加载 -->
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" id="saveLlmSettingsBtn">
                                        <i class="bi bi-save"></i> 保存配置
                                    </button>
                                    <button class="btn btn-outline-secondary" id="resetLlmSettingsBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 通用设置 -->
                    <div class="tab-pane fade" id="general">
                        <div class="card shadow">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-sliders"></i> 通用设置</h5>
                            </div>
                            <div class="card-body">
                                <form id="generalSettingsForm">
                                    <div class="mb-3">
                                        <label class="form-label">数据源</label>
                                        <select class="form-select" id="dataSource">
                                            <option value="akshare" selected>AkShare (推荐)</option>
                                            <option value="tushare">TuShare</option>
                                            <option value="baostock">BaoStock</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">数据缓存时间 (分钟)</label>
                                        <input type="number" class="form-control" id="dataCacheTtl" value="30">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">并行分析线程数</label>
                                        <input type="number" class="form-control" id="threadCount" value="4" min="1" max="8">
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" checked id="enableML">
                                        <label class="form-check-label" for="enableML">启用机器学习评分</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 保存设置
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Agent 配置 -->
                    <div class="tab-pane fade" id="agent">
                        <div class="card shadow">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-cpu"></i> Agent 配置</h5>
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="agentAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#agent1">
                                                估值 Agent
                                            </button>
                                        </h2>
                                        <div id="agent1" class="accordion-collapse collapse show" data-bs-parent="#agentAccordion">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <label class="form-label">DCF 权重</label>
                                                        <input type="number" class="form-control" value="0.4" step="0.1" min="0" max="1">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">PE 权重</label>
                                                        <input type="number" class="form-control" value="0.3" step="0.1" min="0" max="1">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">PB 权重</label>
                                                        <input type="number" class="form-control" value="0.3" step="0.1" min="0" max="1">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#agent2">
                                                风险管理 Agent
                                            </button>
                                        </h2>
                                        <div id="agent2" class="accordion-collapse collapse" data-bs-parent="#agentAccordion">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="form-label">最大仓位 (%)</label>
                                                        <input type="number" class="form-control" value="20" min="1" max="100">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">止损比例 (%)</label>
                                                        <input type="number" class="form-control" value="10" min="1" max="50">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-3">
                                    <i class="bi bi-save"></i> 保存配置
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 通知设置 -->
                    <div class="tab-pane fade" id="notification">
                        <div class="card shadow">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bell"></i> 通知设置</h5>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="mb-3">
                                        <label class="form-label">邮件地址</label>
                                        <input type="email" class="form-control" placeholder="your@email.com">
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailBuy">
                                        <label class="form-check-label" for="emailBuy">买入信号通知</label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailSell">
                                        <label class="form-check-label" for="emailSell">卖出信号通知</label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailDaily">
                                        <label class="form-check-label" for="emailDaily">每日报告</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 保存设置
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 关于 -->
                    <div class="tab-pane fade" id="about">
                        <div class="card shadow">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-info-circle"></i> 关于 VIMaster</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <h1 class="display-4 text-primary">
                                        <i class="bi bi-graph-up-arrow"></i> VIMaster
                                    </h1>
                                    <p class="lead">价值投资分析系统 v2.0</p>
                                </div>

                                <h6>核心功能</h6>
                                <ul>
                                    <li>9 大智能 Agent 综合分析</li>
                                    <li><strong>7 位投资大师 LLM Agent</strong></li>
                                    <li><strong>6 位分析专家 LLM Agent</strong></li>
                                    <li>机器学习评分模型</li>
                                    <li>多数据源支持 (AkShare/TuShare/BaoStock)</li>
                                    <li>实时行情推送</li>
                                    <li>PDF/Excel 报告生成</li>
                                    <li>可视化图表</li>
                                    <li>定时任务与邮件通知</li>
                                    <li>RESTful API 服务</li>
                                    <li>社区分享功能</li>
                                </ul>

                                <h6>支持的 LLM</h6>
                                <p>OpenAI (GPT-4o, GPT-4, GPT-3.5) | Anthropic Claude | DeepSeek | 通义千问 | 智谱 GLM | Ollama</p>

                                <h6>技术栈</h6>
                                <p>Python 3.8+ | Flask | Bootstrap 5 | SQLite</p>

                                <h6>开源协议</h6>
                                <p>MIT License</p>

                                <div class="text-center mt-4">
                                    <p class="text-muted">© 2026 VIMaster. All rights reserved.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">VIMaster v2.0 - 让价值投资更智能</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let availableModels = [];
        let currentSettings = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadLlmSettings();
            loadLlmModels();
        });

        // 加载 LLM 设置
        function loadLlmSettings() {
            fetch('/api/settings/llm')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentSettings = data.data;

                        // 设置默认提供商
                        document.getElementById('defaultProvider').value = currentSettings.default_provider || 'gpt-3.5-turbo';

                        // 设置 API 密钥状态
                        updateApiKeyStatus(currentSettings.api_keys_status || {});

                        // 设置高级选项
                        document.getElementById('enableCache').checked = currentSettings.enable_cache !== false;
                        document.getElementById('logRequests').checked = currentSettings.log_requests !== false;
                        document.getElementById('cacheTtl').value = currentSettings.cache_ttl || 3600;
                    }
                })
                .catch(err => console.error('加载 LLM 设置失败:', err));
        }

        // 加载可用模型列表
        function loadLlmModels() {
            fetch('/api/settings/llm/models')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        availableModels = data.data.models;
                        const select = document.getElementById('defaultProvider');
                        select.innerHTML = '';

                        // 按提供商分组
                        const providers = data.data.providers;
                        const providerNames = data.data.provider_names;

                        for (const [provider, models] of Object.entries(providers)) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = providerNames[provider] || provider;

                            models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.name;
                                option.textContent = model.name;
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        }

                        // 恢复选中值
                        if (currentSettings.default_provider) {
                            select.value = currentSettings.default_provider;
                        }

                        // 加载 Agent 配置
                        loadAgentConfigs();
                    }
                })
                .catch(err => console.error('加载模型列表失败:', err));
        }

        // 更新 API 密钥状态
        function updateApiKeyStatus(status) {
            const providers = ['openai', 'anthropic', 'deepseek', 'qwen', 'zhipu'];
            providers.forEach(p => {
                const el = document.getElementById('status' + p.charAt(0).toUpperCase() + p.slice(1));
                if (el) {
                    if (status[p]) {
                        el.innerHTML = '<span class="badge bg-success"><i class="bi bi-check"></i> 已配置</span>';
                    } else {
                        el.innerHTML = '<span class="badge bg-secondary">未配置</span>';
                    }
                }
            });
        }

        // 加载 Agent 专属配置
        function loadAgentConfigs() {
            const container = document.getElementById('agentConfigsContainer');
            const agents = [
                { name: 'WarrenBuffettAgent', label: '巴菲特 Agent' },
                { name: 'BenGrahamAgent', label: '格雷厄姆 Agent' },
                { name: 'CharlieMungerAgent', label: '芒格 Agent' },
                { name: 'FundamentalsAgent', label: '基本面专家' },
                { name: 'TechnicalAgent', label: '技术分析专家' },
                { name: 'PortfolioManagerAgent', label: '组合管理专家' },
            ];

            let html = '<div class="row g-3">';
            agents.forEach(agent => {
                const currentValue = currentSettings.agent_configs?.[agent.name] || '';
                html += `
                    <div class="col-md-6">
                        <label class="form-label small">${agent.label}</label>
                        <select class="form-select form-select-sm agent-model-select" data-agent="${agent.name}">
                            <option value="">使用默认模型</option>
                            ${availableModels.map(m => `<option value="${m.name}" ${currentValue === m.name ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // 切换密码显示
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // 保存 LLM 设置
        document.getElementById('saveLlmSettingsBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 保存中...';

            // 收集数据
            const apiKeys = {};
            document.querySelectorAll('.api-key-input').forEach(input => {
                const provider = input.dataset.provider;
                const value = input.value.trim();
                if (value) {
                    apiKeys[provider] = value;
                }
            });

            const agentConfigs = {};
            document.querySelectorAll('.agent-model-select').forEach(select => {
                const agent = select.dataset.agent;
                const value = select.value;
                if (value) {
                    agentConfigs[agent] = value;
                }
            });

            const data = {
                default_provider: document.getElementById('defaultProvider').value,
                api_keys: apiKeys,
                agent_configs: agentConfigs,
                enable_cache: document.getElementById('enableCache').checked,
                log_requests: document.getElementById('logRequests').checked,
                cache_ttl: parseInt(document.getElementById('cacheTtl').value) || 3600,
            };

            fetch('/api/settings/llm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> 保存配置';

                if (result.success) {
                    // 显示保存成功
                    const indicator = document.getElementById('llmSaveIndicator');
                    indicator.classList.add('show');
                    setTimeout(() => indicator.classList.remove('show'), 3000);

                    // 重新加载设置
                    loadLlmSettings();

                    alert('配置已保存！');
                } else {
                    alert('保存失败: ' + result.error);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> 保存配置';
                alert('保存失败: ' + err);
            });
        });

        // 重置设置
        document.getElementById('resetLlmSettingsBtn').addEventListener('click', function() {
            if (confirm('确定要重置所有 LLM 设置吗？')) {
                loadLlmSettings();
                document.querySelectorAll('.api-key-input').forEach(input => input.value = '');
            }
        });
    </script>
</body>
</html>
