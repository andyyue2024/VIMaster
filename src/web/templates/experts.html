<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析专家 - VIMaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .expert-card { transition: all 0.3s ease; cursor: pointer; }
        .expert-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .expert-card.selected { border: 3px solid #0dcaf0; }
        .expert-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        .workflow-step { position: relative; padding-left: 40px; }
        .workflow-step::before { content: ''; position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background: #dee2e6; }
        .workflow-step:last-child::before { display: none; }
        .workflow-number { position: absolute; left: 0; width: 32px; height: 32px; border-radius: 50%; background: #0dcaf0; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-graph-up-arrow"></i> VIMaster</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house"></i> 首页</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown"><i class="bi bi-search"></i> 分析</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/analyze"><i class="bi bi-cpu"></i> 基础分析</a></li>
                            <li><a class="dropdown-item" href="/masters"><i class="bi bi-mortarboard"></i> 大师分析</a></li>
                            <li><a class="dropdown-item active" href="/experts"><i class="bi bi-person-workspace"></i> 专家分析</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/portfolio"><i class="bi bi-briefcase"></i> 投资组合</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="bi bi-person-workspace text-info"></i> 分析专家</h2>
                <p class="text-muted">使用 6 位专业分析专家，从基本面、技术面、情绪面等多维度分析股票</p>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：分析工作流 -->
            <div class="col-md-4">
                <!-- 股票输入 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-search"></i> 股票代码</h5>
                    </div>
                    <div class="card-body">
                        <input type="text" class="form-control form-control-lg" id="stockCode" placeholder="如：600519">
                    </div>
                </div>

                <!-- 专家工作流 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> 分析工作流</h5>
                    </div>
                    <div class="card-body">
                        <div class="workflow-step mb-3">
                            <div class="workflow-number">1</div>
                            <h6>数据层分析</h6>
                            <small class="text-muted">基本面、技术面、情绪面</small>
                        </div>
                        <div class="workflow-step mb-3">
                            <div class="workflow-number">2</div>
                            <h6>估值层分析</h6>
                            <small class="text-muted">DCF、所有者收益</small>
                        </div>
                        <div class="workflow-step mb-3">
                            <div class="workflow-number">3</div>
                            <h6>风险层分析</h6>
                            <small class="text-muted">头寸限制、风险指标</small>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">4</div>
                            <h6>决策层分析</h6>
                            <small class="text-muted">综合决策、订单生成</small>
                        </div>
                    </div>
                </div>

                <!-- 专家选择 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between">
                        <h5 class="mb-0"><i class="bi bi-people"></i> 选择专家</h5>
                        <button class="btn btn-sm btn-light" id="selectAllBtn">全选</button>
                    </div>
                    <div class="card-body" id="expertsList">
                        <div class="text-center py-3"><div class="spinner-border"></div></div>
                    </div>
                </div>

                <button class="btn btn-info btn-lg w-100 text-white" id="analyzeBtn">
                    <i class="bi bi-lightning"></i> 开始专家分析
                </button>
            </div>

            <!-- 右侧：结果展示 -->
            <div class="col-md-8">
                <div id="resultsArea">
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-person-workspace display-1 text-muted"></i>
                            <h4 class="mt-3 text-muted">选择专家并输入股票代码</h4>
                            <p class="text-muted">每位专家将从专业领域给出独立分析</p>

                            <div class="row mt-4 g-3">
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-graph-up text-primary fs-3"></i>
                                        <p class="mb-0 small">基本面</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-chat-dots text-success fs-3"></i>
                                        <p class="mb-0 small">情绪面</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-calculator text-info fs-3"></i>
                                        <p class="mb-0 small">估值</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-bar-chart text-warning fs-3"></i>
                                        <p class="mb-0 small">技术面</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-shield-check text-danger fs-3"></i>
                                        <p class="mb-0 small">风险管理</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-briefcase text-secondary fs-3"></i>
                                        <p class="mb-0 small">组合管理</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">VIMaster v2.0 - 让价值投资更智能</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedExperts = [];
        const expertIcons = {
            'FundamentalsAgent': 'graph-up',
            'SentimentAgent': 'chat-dots',
            'ValuationExpertAgent': 'calculator',
            'TechnicalAgent': 'bar-chart',
            'RiskManagerAgent': 'shield-check',
            'PortfolioManagerAgent': 'briefcase'
        };
        const expertColors = {
            'FundamentalsAgent': 'primary',
            'SentimentAgent': 'success',
            'ValuationExpertAgent': 'info',
            'TechnicalAgent': 'warning',
            'RiskManagerAgent': 'danger',
            'PortfolioManagerAgent': 'secondary'
        };

        document.addEventListener('DOMContentLoaded', loadExperts);

        function loadExperts() {
            fetch('/api/agents/experts')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('expertsList');
                        let html = '';
                        data.data.forEach(expert => {
                            const icon = expertIcons[expert.name] || 'person';
                            const color = expertColors[expert.name] || 'secondary';
                            html += `
                                <div class="expert-card card mb-2 p-2" data-name="${expert.name}" onclick="toggleExpert(this, '${expert.name}')">
                                    <div class="d-flex align-items-center">
                                        <div class="expert-icon me-3 bg-${color}">
                                            <i class="bi bi-${icon}"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">${expert.name.replace('Agent', '')}</h6>
                                            <small class="text-muted">${expert.description.substring(0, 20)}...</small>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-info" style="display:none;"></i>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    }
                });
        }

        function toggleExpert(el, name) {
            if (selectedExperts.includes(name)) {
                selectedExperts = selectedExperts.filter(e => e !== name);
                el.classList.remove('selected');
                el.querySelector('.bi-check-circle-fill').style.display = 'none';
            } else {
                selectedExperts.push(name);
                el.classList.add('selected');
                el.querySelector('.bi-check-circle-fill').style.display = 'block';
            }
        }

        document.getElementById('selectAllBtn').addEventListener('click', function() {
            const cards = document.querySelectorAll('.expert-card');
            const allSelected = selectedExperts.length === cards.length;

            cards.forEach(card => {
                const name = card.dataset.name;
                if (allSelected) {
                    selectedExperts = [];
                    card.classList.remove('selected');
                    card.querySelector('.bi-check-circle-fill').style.display = 'none';
                } else {
                    if (!selectedExperts.includes(name)) selectedExperts.push(name);
                    card.classList.add('selected');
                    card.querySelector('.bi-check-circle-fill').style.display = 'block';
                }
            });
            this.textContent = allSelected ? '全选' : '取消全选';
        });

        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                alert('请输入股票代码');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 分析中...';

            document.getElementById('resultsArea').innerHTML = `
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-info" style="width:3rem;height:3rem;"></div>
                        <h4 class="mt-3">正在进行专家分析...</h4>
                        <p class="text-muted">6 位专家正在分析 ${stockCode}</p>
                    </div>
                </div>
            `;

            fetch('/api/analyze/experts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    stock_code: stockCode,
                    experts: selectedExperts.length > 0 ? selectedExperts : null
                })
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-lightning"></i> 开始专家分析';

                if (data.success) {
                    renderResults(data.data);
                } else {
                    document.getElementById('resultsArea').innerHTML = `
                        <div class="alert alert-danger">${data.error}</div>
                    `;
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-lightning"></i> 开始专家分析';
                document.getElementById('resultsArea').innerHTML = `
                    <div class="alert alert-danger">分析失败: ${err}</div>
                `;
            });
        });

        function renderResults(data) {
            const signalColors = {bullish: 'success', bearish: 'danger', neutral: 'warning'};
            const signalText = {bullish: '看涨', bearish: '看跌', neutral: '中性'};

            let html = `
                <!-- 共识卡片 -->
                <div class="card shadow-sm mb-4 border-${signalColors[data.consensus.consensus] || 'secondary'}">
                    <div class="card-header bg-${signalColors[data.consensus.consensus] || 'secondary'} text-white">
                        <h4 class="mb-0"><i class="bi bi-clipboard-data"></i> 专家共识 - ${data.stock_code}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h1 class="text-${signalColors[data.consensus.consensus]}">${signalText[data.consensus.consensus] || '未知'}</h1>
                                <p class="text-muted">共识信号</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-success">${data.consensus.bullish_count}</h2>
                                <p class="text-muted">看涨</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-warning">${data.consensus.neutral_count}</h2>
                                <p class="text-muted">中性</p>
                            </div>
                            <div class="col-md-3">
                                <h2 class="text-danger">${data.consensus.bearish_count}</h2>
                                <p class="text-muted">看跌</p>
                            </div>
                        </div>
                        <p class="text-center mt-2 mb-0">
                            平均信心度: <strong>${(data.consensus.average_confidence || 0).toFixed(1)}%</strong>
                        </p>
                    </div>
                </div>

                <h5 class="mb-3"><i class="bi bi-person-lines-fill"></i> 各专家分析详情</h5>
            `;

            if (data.experts && data.experts.length > 0) {
                data.experts.forEach(expert => {
                    const icon = expertIcons[expert.name] || 'person';
                    const cardColor = expertColors[expert.name] || 'secondary';
                    const signalColor = signalColors[expert.signal] || 'secondary';

                    html += `
                        <div class="card shadow-sm mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <span class="badge bg-${cardColor} me-2"><i class="bi bi-${icon}"></i></span>
                                    ${expert.name.replace('Agent', '')}
                                </h5>
                                <span class="badge bg-${signalColor} fs-6">
                                    ${signalText[expert.signal]} (${expert.confidence.toFixed(1)}%)
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="bg-light p-3 rounded" style="max-height:150px;overflow-y:auto;">
                                    ${expert.reasoning || '暂无详细分析'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-warning">未获取到专家分析结果，请确保已配置 LLM API 密钥</div>`;
            }

            document.getElementById('resultsArea').innerHTML = html;
        }
    </script>
</body>
</html>
